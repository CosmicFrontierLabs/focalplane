name: ARM64 Build (SelfHost)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # Allow manual triggering

env:
  CARGO_TERM_COLOR: always

jobs:
  build-arm64:
    # Self-hosted ARM64 runner on cfl-test-bench
    # Setup: scripts/setup-github-runner.sh
    runs-on: [self-hosted, Linux, ARM64, arm64-builder]

    steps:
    - uses: actions/checkout@v4

    # No need to install Rust or system deps - pre-installed on self-hosted runner
    # See scripts/setup-github-runner.sh for dependency list
    # Note: No GitHub Actions cache here - self-hosted runner has persistent local storage

    - name: Check Rust version
      run: |
        source ~/.cargo/env
        rustc --version
        cargo --version

    # Build frontends first - required for embedded assets in server binaries
    - name: Build frontends (for embedding)
      run: |
        source ~/.cargo/env
        # Ensure wasm target is available
        rustup target add wasm32-unknown-unknown || true
        # Install trunk if not available
        command -v trunk || cargo install --locked trunk
        # Install matching wasm-bindgen-cli
        WASM_BINDGEN_VERSION=$(grep -A1 'name = "wasm-bindgen"' Cargo.lock | grep version | head -1 | sed 's/.*"\(.*\)".*/\1/')
        cargo install wasm-bindgen-cli --version "$WASM_BINDGEN_VERSION" --locked || true
        # Build frontends
        cd test-bench-frontend
        trunk build --config Trunk-calibrate.toml
        trunk build --config Trunk-fgs.toml

    - name: Build fgs_server (NSV455 camera)
      run: |
        source ~/.cargo/env
        cargo build --release --package test-bench --bin fgs_server --features nsv455,pi-fsm

    - name: Build fgs_server (PlayerOne camera)
      run: |
        source ~/.cargo/env
        cargo build --release --package test-bench --bin fgs_server --features playerone,pi-fsm
      continue-on-error: true  # May fail if libplayeronecamera2 not available

    - name: Build calibration_controller
      run: |
        source ~/.cargo/env
        cargo build --release --package test-bench --bin calibration_controller

    - name: List built binaries
      run: |
        echo "Built ARM64 binaries:"
        ls -lh target/release/fgs_server target/release/calibration_controller 2>/dev/null || true
        file target/release/fgs_server target/release/calibration_controller 2>/dev/null || true

    - name: Upload ARM64 artifacts
      uses: actions/upload-artifact@v4
      with:
        name: arm64-binaries
        path: |
          target/release/fgs_server
          target/release/calibration_controller
        retention-days: 7
