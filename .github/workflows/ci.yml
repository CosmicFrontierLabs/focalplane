name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  CARGO_TERM_COLOR: always

jobs:
  test:
    runs-on: ubuntu-latest-medium

    steps:
    - uses: actions/checkout@v4

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: wasm32-unknown-unknown

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libfontconfig1-dev libsdl2-dev libsdl2-image-dev libplayeronecamera2 libssl-dev pkg-config

    - name: Cache cargo dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/bin
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-

    - name: Ensure wasm32 target
      run: rustup target add wasm32-unknown-unknown

    # Build frontends first - required for embedded assets in server binaries
    - name: Install wasm-bindgen-cli
      run: |
        WASM_BINDGEN_VERSION=$(grep -A1 'name = "wasm-bindgen"' Cargo.lock | grep version | head -1 | sed 's/.*"\(.*\)".*/\1/')
        echo "Installing wasm-bindgen-cli version $WASM_BINDGEN_VERSION"
        cargo install wasm-bindgen-cli --version "$WASM_BINDGEN_VERSION" --locked || true

    - name: Install Trunk
      uses: jetli/trunk-action@v0.4.0
      with:
        version: 'v0.21.4'

    - name: Build frontends (for embedding)
      run: |
        cd test-bench-frontend
        trunk build --config Trunk-calibrate.toml
        trunk build --config Trunk-fgs.toml

    - name: Check Cargo.lock is up to date
      run: cargo check --locked --all-targets

    - name: Run tests
      run: cargo test --verbose

    - name: Run hardware driver tests
      run: cargo test --package hardware --features ci-testable --verbose
