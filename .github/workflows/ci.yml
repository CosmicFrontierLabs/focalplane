name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  CARGO_TERM_COLOR: always

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libfontconfig1-dev libcfitsio-dev libsdl2-dev libsdl2-image-dev
      
    - name: Cache cargo dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
        
    - name: Run tests with timing
      id: run_tests
      run: |
        # Measure total test time (including any compilation needed)
        START_TIME=$(date +%s.%N)
        cargo test --verbose
        END_TIME=$(date +%s.%N)
        TEST_TIME=$(echo "$END_TIME - $START_TIME" | bc)

        echo "Test execution time: ${TEST_TIME}s"
        echo "test_time=$TEST_TIME" >> $GITHUB_OUTPUT

    - name: Push test metrics to Grafana
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      env:
        GRAPHANA_CLOUD_API_TOKEN: ${{ secrets.GRAPHANA_CLOUD_API_TOKEN }}
      run: |
        # Get test time, default to 0 if not available
        TEST_TIME="${{ steps.run_tests.outputs.test_time }}"
        if [ -z "$TEST_TIME" ] || (( $(echo "$TEST_TIME < 0" | bc -l) )); then
          TEST_TIME="0"
          echo "Warning: Invalid test time, using 0"
        fi

        # Only push test execution time metric (not build time)
        python scripts/push_metric.py meter_sim_test_execution_seconds "$TEST_TIME" \
          --label phase=test_execution \
          --label status=${{ job.status }}

  cross-compile-arm64:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: aarch64-unknown-linux-gnu
    
    - name: Add ARM64 target
      run: rustup target add aarch64-unknown-linux-gnu
        
    - name: Install ARM64 cross-compilation tools
      run: |
        sudo apt-get update
        sudo apt-get install -y gcc-aarch64-linux-gnu libc6-dev-arm64-cross
        
    - name: Cache cargo dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-arm64-cargo-${{ hashFiles('**/Cargo.lock') }}
        
    - name: Build flight-software for ARM64
      run: |
        CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER=aarch64-linux-gnu-gcc \
        cargo build --target aarch64-unknown-linux-gnu --release --bin flight_monitor
        
    - name: Verify ARM64 binary
      run: |
        file target/aarch64-unknown-linux-gnu/release/flight_monitor
        ls -lh target/aarch64-unknown-linux-gnu/release/flight_monitor
        
    - name: Test binary architecture
      run: |
        ARCH=$(file target/aarch64-unknown-linux-gnu/release/flight_monitor | grep -o "ARM aarch64")
        if [ "$ARCH" = "ARM aarch64" ]; then
          echo "✓ ARM64 binary verified successfully"
        else
          echo "✗ Binary is not ARM64 architecture"
          exit 1
        fi

