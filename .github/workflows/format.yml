name: Format & Clippy Check

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

env:
  CARGO_TERM_COLOR: always

jobs:
  format-and-clippy:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Rust
      uses: ./.github/actions/setup
      with:
        install-deps: 'true'
        setup-cache: 'true'

    - name: Add wasm32 target
      run: rustup target add wasm32-unknown-unknown

    # Build frontends - required for embedded assets in clippy check
    - name: Install wasm-bindgen-cli
      run: |
        WASM_BINDGEN_VERSION=$(grep -A1 'name = "wasm-bindgen"' Cargo.lock | grep version | head -1 | sed 's/.*"\(.*\)".*/\1/')
        echo "Installing wasm-bindgen-cli version $WASM_BINDGEN_VERSION"
        cargo install wasm-bindgen-cli --version "$WASM_BINDGEN_VERSION" --locked || true

    - name: Install Trunk
      uses: jetli/trunk-action@v0.4.0
      with:
        version: 'v0.21.4'

    - name: Build frontends (for embedding)
      run: |
        cd test-bench-frontend
        trunk build --config Trunk-calibrate.toml
        trunk build --config Trunk-fgs.toml

    - name: Check formatting
      run: cargo fmt --all -- --check
    
    - name: Run clippy
      run: cargo clippy -- -D warnings